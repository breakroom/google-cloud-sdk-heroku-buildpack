#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BUILDPACK_DIR=`cd $(dirname $0); cd ..; pwd`

APP_DIR="$BUILD_DIR/google-cloud-sdk"

DEFAULT_SDK_VERSION="351.0.0"
if [ -r "$ENV_DIR/GOOGLE_CLOUD_SDK_VERSION" ]; then
	SDK_VERSION=$(cat "${ENV_DIR}/GOOGLE_CLOUD_SDK_VERSION")
else
  SDK_VERSION="$DEFAULT_SDK_VERSION"
fi

# This may not exist already
mkdir -p "$CACHE_DIR"

DOWNLOAD_FILE="google-cloud-sdk-${SDK_VERSION}-linux-x86_64.tar.gz"

if [ -f "$CACHE_DIR/$DOWNLOAD_FILE" ]; then
  echo "$DOWNLOAD_FILE already exists in cache, skipping download"
else
  echo "Downloading $DOWNLOAD_FILE to cache"
  wget -q "https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/$DOWNLOAD_FILE" -O "$CACHE_DIR/$DOWNLOAD_FILE"
  echo "Downloaded $DOWNLOAD_FILE to cache"
fi

mkdir -p "$APP_DIR"

tar zxf "$CACHE_DIR/$DOWNLOAD_FILE" --directory "$APP_DIR" --strip-components=1
$APP_DIR/install.sh --usage-reporting=false --path-update=false --bash-completion=false

cp "$BUILDPACK_DIR/profile.d/heroku-google-cloud-sdk.sh" "$BUILD_DIR/.profile.d"